<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Tata Surya 3D Interaktif</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: sans-serif;
        }

        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type=range] {
            width: 200px;
            cursor: pointer;
        }

        #speed-val {
            color: #00ffcc;
            font-weight: bold;
        }

        .instruction {
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
        }

        #copyright {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 12px;
            pointer-events: none;
            font-family: sans-serif;
            z-index: 1000;
        }

        #music-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            z-index: 1000;
        }

        #music-toggle {
            background: rgba(0, 200, 180, 0.2);
            border: 1px solid #00c8b4;
            color: #00ffcc;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        #music-toggle:hover {
            background: rgba(0, 200, 180, 0.4);
        }

        /* Mobile Responsive Styles */
        @media only screen and (max-width: 768px) {
            #ui-container {
                top: 10px;
                left: 10px;
                padding: 8px;
                font-size: 11px;
            }

            label {
                font-size: 11px;
                margin-bottom: 3px;
            }

            input[type=range] {
                width: 120px;
            }

            #speed-val {
                font-size: 12px;
            }

            .instruction {
                font-size: 9px;
                margin-top: 5px;
            }

            #music-control {
                top: 10px;
                right: 10px;
                padding: 6px;
            }

            #music-toggle {
                padding: 6px 10px;
                font-size: 12px;
            }

            #copyright {
                font-size: 9px;
                bottom: 5px;
            }
        }
    </style>
</head>

<body>

    <div id="ui-container">
        <label>Kecepatan Waktu: <span id="speed-val">1x</span></label>
        <input type="range" id="speed-slider" min="0" max="50" step="0.5" value="1">
        <div class="instruction">
            Geser untuk mempercepat orbit.<br>
            Klik & Tahan mouse untuk memutar kamera.<br>
            Scroll untuk Zoom.
        </div>
    </div>

    <div id="music-control">
        <button id="music-toggle">ðŸ”Š Musik</button>
    </div>

    <div id="copyright">
        &copy; Project By Tycami Tech. All rights reserved.
    </div>

    <!-- Background Music -->
    <audio id="bgMusic" loop>
        <source src="backsound/struct.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

        // Music Control
        const bgMusic = document.getElementById('bgMusic');
        const musicToggle = document.getElementById('music-toggle');

        let isMusicPlaying = false;

        // Set volume to high (90%)
        bgMusic.volume = 0.9;

        // Auto-play music when user interacts with page (browser policy)
        const startMusic = () => {
            bgMusic.play().then(() => {
                isMusicPlaying = true;
                musicToggle.textContent = 'ðŸ”Š Musik';
            }).catch(err => {
                console.log('Autoplay prevented:', err);
            });
        };

        // Try to start music on first user interaction
        document.addEventListener('click', function initMusic() {
            startMusic();
            document.removeEventListener('click', initMusic);
        }, { once: true });

        // Music toggle button
        musicToggle.addEventListener('click', () => {
            if (isMusicPlaying) {
                bgMusic.pause();
                musicToggle.textContent = 'ðŸ”‡ Musik';
                isMusicPlaying = false;
            } else {
                bgMusic.play();
                musicToggle.textContent = 'ðŸ”Š Musik';
                isMusicPlaying = true;
            }
        });

        // 1. SETUP DASAR (Scene, Camera, Renderer)
        const scene = new THREE.Scene();

        // Kamera (Perspective)
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 20000);
        camera.position.set(0, 600, 1500); // Posisi awal kamera (lebih jauh agar terlihat semua)

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        // Optimasi resolusi untuk layar mobile/retina (batasi max 2x untuk performa)
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // Kontrol Orbit (Mouse)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxDistance = 5000; // Batasi zoom out

        // 2. PENCAHAYAAN & LATAR BELAKANG
        // Bintang-bintang background
        const starGeometry = new THREE.BufferGeometry();
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff });
        const starVertices = [];
        for (let i = 0; i < 20000; i++) { // Lebih banyak bintang untuk area yang lebih luas
            const x = (Math.random() - 0.5) * 4000;
            const y = (Math.random() - 0.5) * 4000;
            const z = (Math.random() - 0.5) * 4000;
            starVertices.push(x, y, z);
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);

        // Cahaya Matahari (Point Light) - Menyinari ke segala arah
        const sunLight = new THREE.PointLight(0xffffff, 1.5, 5000);
        scene.add(sunLight);

        // Cahaya Ambien (agar sisi gelap planet tidak hitam pekat)
        const ambientLight = new THREE.AmbientLight(0x333333);
        scene.add(ambientLight);

        // 3. OBJEK (Matahari & Planet)
        const textureLoader = new THREE.TextureLoader();
        const maxAnisotropy = renderer.capabilities.getMaxAnisotropy(); // Ambil kemampuan maksimal GPU

        // Base URL for textures
        const texURL = 'https://raw.githubusercontent.com/KyleGough/solar-system/master/static/textures/';

        // Array Data Planet & Satelit
        // Jarak diperluas agar tidak berdempetan
        const planetsData = [
            {
                name: "Merkurius", texture: texURL + 'mercury.jpg', size: 2.4, distance: 80, speed: 0.04,
                moons: []
            },
            {
                name: "Venus", texture: texURL + 'venus.jpg', size: 5.8, distance: 130, speed: 0.015,
                rotDir: 'CW', // Searah jarum jam (Retrograde)
                moons: []
            },
            {
                name: "Bumi", texture: texURL + 'earth.jpg', size: 6, distance: 190, speed: 0.01,
                moons: [
                    { name: "Bulan", texture: texURL + 'moon.jpg', size: 1.5, distance: 10, speed: 0.05 }
                ]
            },
            {
                name: "Mars", texture: texURL + 'mars.jpg', size: 3.2, distance: 260, speed: 0.008,
                moons: [
                    { name: "Phobos", texture: texURL + 'moon.jpg', size: 0.4, distance: 5, speed: 0.08 },
                    { name: "Deimos", texture: texURL + 'moon.jpg', size: 0.3, distance: 7, speed: 0.06 }
                ]
            },
            {
                name: "Jupiter", texture: texURL + 'jupiter.jpg', size: 20, distance: 400, speed: 0.002,
                moons: [
                    { name: "Io", texture: texURL + 'io.jpg', size: 2, distance: 28, speed: 0.04 },
                    { name: "Europa", texture: texURL + 'europa.jpg', size: 1.8, distance: 34, speed: 0.035 },
                    { name: "Ganymede", texture: texURL + 'ganymede.jpg', size: 3, distance: 42, speed: 0.03 },
                    { name: "Callisto", texture: texURL + 'callisto.jpg', size: 2.8, distance: 50, speed: 0.025 }
                ]
            },
            {
                name: "Saturnus", texture: texURL + 'saturn.jpg', size: 17, distance: 550, speed: 0.0009, ring: true, ringTexture: texURL + 'saturn-ring.png',
                moons: [
                    { name: "Titan", texture: texURL + 'titan.webp', size: 3.2, distance: 35, speed: 0.03 },
                    { name: "Rhea", texture: texURL + 'moon.jpg', size: 1.2, distance: 25, speed: 0.05 },
                    { name: "Iapetus", texture: texURL + 'moon.jpg', size: 1.1, distance: 45, speed: 0.02 }
                ]
            },
            {
                name: "Uranus", texture: texURL + 'uranus.jpg', size: 10, distance: 700, speed: 0.0004,
                rotDir: 'CW', // Searah jarum jam (Retrograde)
                axisTilt: 98 * (Math.PI / 180), // Miring 98 derajat
                moons: [
                    { name: "Titania", texture: texURL + 'moon.jpg', size: 1.2, distance: 18, speed: 0.04 },
                    { name: "Oberon", texture: texURL + 'moon.jpg', size: 1.1, distance: 22, speed: 0.035 }
                ]
            },
            {
                name: "Neptunus", texture: texURL + 'neptune.jpg', size: 9.8, distance: 850, speed: 0.0001,
                moons: [
                    { name: "Triton", texture: texURL + 'triton.jpg', size: 2, distance: 18, speed: 0.04 }
                ]
            },
            {
                name: "Pluto", texture: 'https://www.solarsystemscope.com/textures/download/2k_pluto_fictional.jpg', size: 2.3, distance: 1000, speed: 0.00007,
                inclination: 17 * (Math.PI / 180), // Inklinasi orbit 17 derajat
                moons: []
            }
        ];

        // Buat Matahari
        const sunGeo = new THREE.SphereGeometry(25, 32, 32);
        const sunTexture = textureLoader.load(texURL + 'sun.jpg');
        // Optimasi tekstur matahari
        sunTexture.anisotropy = maxAnisotropy;

        const sunMat = new THREE.MeshBasicMaterial({ map: sunTexture });
        const sunMesh = new THREE.Mesh(sunGeo, sunMat);
        scene.add(sunMesh);

        // Fungsi untuk membuat lintasan orbit (garis putih tipis)
        function createOrbitLine(distance, inclination = 0) {
            const curve = new THREE.EllipseCurve(
                0, 0,            // ax, aY
                distance, distance, // xRadius, yRadius
                0, 2 * Math.PI,  // aStartAngle, aEndAngle
                false,           // aClockwise
                0                // aRotation
            );
            const points = curve.getPoints(300); // Lebih halus untuk orbit besar
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            // Warna putih terang seperti di gambar referensi
            const material = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
            const orbit = new THREE.LineLoop(geometry, material); // LineLoop agar lingkaran tertutup sempurna
            // Terapkan inklinasi orbit (miring)
            orbit.rotation.x = Math.PI / 2 - inclination;
            return orbit;
        }

        // Fungsi untuk membuat Sabuk Asteroid & Kuiper Belt
        function createBelt(innerRadius, outerRadius, count, sizeRange) {
            const geometry = new THREE.DodecahedronGeometry(1, 0); // Bentuk asteroid sederhana
            const material = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.8, metalness: 0.2 });
            const mesh = new THREE.InstancedMesh(geometry, material, count);

            const dummy = new THREE.Object3D();
            for (let i = 0; i < count; i++) {
                // Posisi acak dalam cincin
                const r = innerRadius + Math.random() * (outerRadius - innerRadius);
                const theta = Math.random() * Math.PI * 2;

                // Variasi ketinggian (agar tidak terlalu datar)
                const y = (Math.random() - 0.5) * 10;

                dummy.position.set(
                    Math.cos(theta) * r,
                    y,
                    Math.sin(theta) * r
                );

                // Rotasi acak
                dummy.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);

                // Skala acak
                const s = sizeRange.min + Math.random() * (sizeRange.max - sizeRange.min);
                dummy.scale.set(s, s, s);

                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);
            }
            scene.add(mesh);
            return mesh;
        }

        // Buat Asteroid Belt (antara Mars & Jupiter)
        // Mars: 260, Jupiter: 400
        const asteroidBelt = createBelt(290, 360, 2000, { min: 0.5, max: 2 });

        // Buat Kuiper Belt (setelah Neptunus)
        // Neptunus: 850
        const kuiperBelt = createBelt(900, 1400, 4000, { min: 1, max: 3 });

        const planetsMeshes = [];

        // Loop untuk membuat semua planet
        planetsData.forEach(p => {
            // 1. Mesh Planet
            const geo = new THREE.SphereGeometry(p.size, 32, 32);
            const texture = textureLoader.load(p.texture);
            // Optimasi tekstur planet
            texture.anisotropy = maxAnisotropy;

            const mat = new THREE.MeshStandardMaterial({ map: texture });
            const mesh = new THREE.Mesh(geo, mat);

            // Terapkan kemiringan sumbu (Axis Tilt) jika ada (misal Uranus)
            if (p.axisTilt) {
                mesh.rotation.z = p.axisTilt;
            }

            // Grup untuk menampung planet (agar rotasi lokal dan revolusi terpisah)
            const obj = new THREE.Object3D();
            obj.add(mesh);

            // Tambahkan Cincin jika Saturnus
            if (p.ring) {
                const ringGeo = new THREE.RingGeometry(p.size + 4, p.size + 12, 64);
                const ringTexture = textureLoader.load(p.ringTexture);
                // Optimasi tekstur cincin
                ringTexture.anisotropy = maxAnisotropy;

                // Adjust UV mapping for the ring to map the texture radially
                const pos = ringGeo.attributes.position;
                const v3 = new THREE.Vector3();
                for (let i = 0; i < pos.count; i++) {
                    v3.fromBufferAttribute(pos, i);
                    ringGeo.attributes.uv.setXY(i, v3.length() < p.size + 8 ? 0 : 1, 1);
                }

                const ringMat = new THREE.MeshBasicMaterial({
                    map: ringTexture,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.8
                });
                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 2;
                obj.add(ring);
            }

            // Tambahkan Moons (Satelit)
            const moonMeshes = [];
            if (p.moons) {
                p.moons.forEach(m => {
                    const mGeo = new THREE.SphereGeometry(m.size, 16, 16);
                    const mTex = textureLoader.load(m.texture);
                    // Optimasi tekstur bulan
                    mTex.anisotropy = maxAnisotropy;

                    const mMat = new THREE.MeshStandardMaterial({ map: mTex });
                    const mMesh = new THREE.Mesh(mGeo, mMat);

                    // Tambahkan ke grup planet
                    obj.add(mMesh);

                    moonMeshes.push({
                        mesh: mMesh,
                        dist: m.distance,
                        speed: m.speed,
                        angle: Math.random() * Math.PI * 2
                    });
                });
            }

            scene.add(obj);

            // Tambahkan garis orbit visual (dengan inklinasi jika ada)
            const orbitLine = createOrbitLine(p.distance, p.inclination || 0);
            scene.add(orbitLine);

            // Simpan referensi untuk animasi
            planetsMeshes.push({
                mesh: obj,
                planetMesh: mesh, // Referensi ke mesh planet asli
                dist: p.distance,
                speed: p.speed,
                angle: Math.random() * Math.PI * 2, // Mulai dari posisi acak
                moons: moonMeshes,
                inclination: p.inclination || 0, // Simpan inklinasi
                rotDir: p.rotDir || 'CCW' // Default Counter-Clockwise
            });
        });

        // 4. LOGIKA WAKTU (UI)
        let timeSpeed = 1;
        const slider = document.getElementById('speed-slider');
        const speedVal = document.getElementById('speed-val');

        slider.addEventListener('input', (e) => {
            timeSpeed = parseFloat(e.target.value);
            speedVal.innerText = timeSpeed + "x";
        });

        // 5. ANIMASI LOOP
        function animate() {
            requestAnimationFrame(animate);

            // Rotasi Matahari (sedikit saja)
            sunMesh.rotation.y += 0.004;

            // Update Posisi Planet (Revolusi & Rotasi)
            planetsMeshes.forEach(p => {
                // Update sudut berdasarkan kecepatan dan timeSpeed
                p.angle += p.speed * timeSpeed;

                // Rumus Trigonometri untuk posisi melingkar dengan Inklinasi
                // x = r * cos(a)
                // z_flat = r * sin(a)
                // y = z_flat * sin(inc) (Rotasi di sumbu X)
                // z = z_flat * cos(inc)

                const x = Math.cos(p.angle) * p.dist;
                const z_flat = Math.sin(p.angle) * p.dist;

                // Rotasi posisi berdasarkan inklinasi (mengangkat orbit)
                p.mesh.position.x = x;
                p.mesh.position.y = -z_flat * Math.sin(p.inclination);
                p.mesh.position.z = z_flat * Math.cos(p.inclination);

                // Rotasi planet pada porosnya sendiri
                // CW = -1 (Clockwise / Retrograde), CCW = 1 (Counter-Clockwise / Prograde)
                const dir = p.rotDir === 'CW' ? -1 : 1;
                p.planetMesh.rotation.y += 0.01 * timeSpeed * dir;

                // Update Posisi Moons
                if (p.moons) {
                    p.moons.forEach(m => {
                        m.angle += m.speed * timeSpeed;
                        m.mesh.position.x = Math.cos(m.angle) * m.dist;
                        m.mesh.position.z = Math.sin(m.angle) * m.dist;
                        // Rotasi bulan pada porosnya (opsional)
                        m.mesh.rotation.y += 0.02 * timeSpeed;
                    });
                }
            });

            controls.update();
            renderer.render(scene, camera);
        }

        // Responsif saat window di-resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        });

        animate();
    </script>
</body>

</html>